# Загрузка поддержки взаимодействия с ROS
import("rtt_ros");
ros.import("rtt_sensor_msgs")
ros.import("rtt_sweetie_bot_kinematics_msgs")
ros.import("rtt_rospack");  # Разрешение путей ROS: операци ros.find(<package name>)
ros.import("rtt_rosparam");
ros.import("sweetie_bot_logger");

require("print");
import("sweetie_bot_robot_model");
import("sweetie_bot_agregator");
import("sweetie_bot_kinematics");

# Logger
var string LOGGER_SCRIPTS = ros.find("sweetie_bot_logger") + "/scripts/";
loadComponent("sweetie_bot_logger", "OCL::logging::LoggingService");
loadService("sweetie_bot_logger","marshalling"); # Поддержка исполнения скрип:тов и загрузки xml/cpf файлов
sweetie_bot_logger.marshalling.loadProperties(LOGGER_SCRIPTS + "log_ocl.cpf");

loadComponent("sweetie_bot_agregator", "sweetie_bot::Agregator");
loadService("sweetie_bot_agregator","rosparam");
loadService("sweetie_bot_agregator","marshalling"); # Поддержка исполнения скриптов и загрузки xml/cpf файлов

## Create ROS mapping
stream("sweetie_bot_agregator.in_joints", ros.topic("/agregator/input_joint_state"))
stream("sweetie_bot_agregator.out_joints_sorted", ros.topic("/agregator/output_joint_state"))

# Загружаем параметры из xml файла.
sweetie_bot_agregator.marshalling.loadProperties(ros.find("sweetie_bot_description_proto2") + "/robots/chains.cpf");
sweetie_bot_agregator.rosparam.getParam("/", "robot_model")

loadComponent("sweetie_bot_kinematics", "sweetie_bot::Kinematics");
loadService("sweetie_bot_kinematics","rosparam");
loadService("sweetie_bot_kinematics","marshalling"); # Поддержка исполнения скриптов и загрузки xml/cpf файлов

## Create ROS mapping
stream("sweetie_bot_kinematics.in_limbs", ros.topic("/kinematics/input_limb_state"))
stream("sweetie_bot_kinematics.out_joints", ros.topic("/kinematics/output_joint_state"))

## Create connections
connect( "sweetie_bot_kinematics.out_joints", "sweetie_bot_agregator.in_joints", ConnPolicy() )

# Загружаем параметры из xml файла.
sweetie_bot_kinematics.marshalling.loadProperties(ros.find("sweetie_bot_description_proto2") + "/robots/chains.cpf");
sweetie_bot_kinematics.rosparam.getParam("/", "robot_model")

sweetie_bot_agregator.configure();
sweetie_bot_agregator.start();

sweetie_bot_kinematics.configure();
sweetie_bot_kinematics.start();
